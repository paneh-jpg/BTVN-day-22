<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Minh hoạ đệ quy nestedUsers</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: radial-gradient(circle at top, #1e293b, #020617);
        color: #e5e7eb;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 24px;
      }

      .app {
        width: 1100px;
        max-width: 100%;
        background: #020617;
        border-radius: 18px;
        box-shadow: 0 24px 60px rgba(0, 0, 0, 0.7);
        border: 1px solid rgba(148, 163, 184, 0.2);
        padding: 20px 24px 26px;
        position: relative;
        overflow: hidden;
      }

      .app::before {
        content: "";
        position: absolute;
        inset: -40%;
        background: radial-gradient(
            circle at 10% 0%,
            rgba(56, 189, 248, 0.18),
            transparent 50%
          ),
          radial-gradient(
            circle at 90% 0%,
            rgba(129, 140, 248, 0.22),
            transparent 55%
          );
        opacity: 0.7;
        pointer-events: none;
        z-index: -1;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        gap: 12px;
      }

      .title-group h1 {
        font-size: 22px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .title-pill {
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid rgba(96, 165, 250, 0.5);
        color: #bae6fd;
        background: rgba(15, 23, 42, 0.7);
      }

      .title-group p {
        font-size: 13px;
        color: #9ca3af;
        margin-top: 4px;
      }

      .controls {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .btn {
        padding: 8px 14px;
        border-radius: 999px;
        border: none;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 3s ease;
      }

      .btn-primary {
        background: linear-gradient(135deg, #38bdf8, #6366f1);
        color: white;
        box-shadow: 0 10px 25px rgba(59, 130, 246, 0.45);
      }

      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 16px 35px rgba(59, 130, 246, 0.65);
        filter: brightness(1.05);
      }

      .btn-secondary {
        background: rgba(15, 23, 42, 0.9);
        color: #e5e7eb;
        border: 1px solid rgba(148, 163, 184, 0.5);
      }

      .btn-secondary:hover {
        background: rgba(15, 23, 42, 1);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .layout {
        display: grid;
        grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.3fr);
        gap: 18px;
        margin-top: 12px;
      }

      .card {
        background: rgba(15, 23, 42, 0.9);
        border-radius: 14px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        padding: 12px 12px 12px;
        position: relative;
        overflow: hidden;
      }

      .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
        gap: 8px;
      }

      .card-title {
        font-size: 13px;
        font-weight: 600;
        color: #e5e7eb;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .card-title span.icon {
        width: 18px;
        height: 18px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 10%, #38bdf8, #6366f1);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        color: white;
      }

      .card-subtitle {
        font-size: 11px;
        color: #9ca3af;
      }

      .badge {
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        color: #9ca3af;
      }

      .list-flat {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 8px;
        margin-top: 6px;
      }

      .node {
        border-radius: 10px;
        border: 1px solid rgba(148, 163, 184, 0.4);
        background: rgba(15, 23, 42, 0.9);
        padding: 8px 9px;
        font-size: 11px;
        display: flex;
        flex-direction: column;
        gap: 3px;
        position: relative;
        overflow: hidden;
        transition: transform 3s ease, box-shadow 3s ease, border-color 3s ease,
          background 3s ease;
      }

      .node-id {
        font-size: 10px;
        color: #9ca3af;
      }

      .node-name {
        font-size: 12px;
        font-weight: 600;
        color: #e5e7eb;
      }

      .node-parent {
        font-size: 10px;
        color: #9ca3af;
      }

      .node-current {
        border-color: #38bdf8;
        box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.7);
        background: radial-gradient(
          circle at top,
          rgba(56, 189, 248, 0.28),
          rgba(15, 23, 42, 0.9)
        );
        transform: translateY(-1px);
      }

      .node-child {
        border-color: #a855f7;
        box-shadow: 0 0 0 1px rgba(168, 85, 247, 0.7);
        background: radial-gradient(
          circle at bottom,
          rgba(168, 85, 247, 0.2),
          rgba(15, 23, 42, 0.9)
        );
      }

      .node-root {
        border-style: dashed;
      }

      .node::after {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(
          circle at top,
          rgba(248, 250, 252, 0.09),
          transparent 60%
        );
        opacity: 0;
        pointer-events: none;
        transition: opacity 1s ease;
      }

      .node-current::after,
      .node-child::after {
        opacity: 1;
      }

      .tree-view {
        margin-top: 4px;
        max-height: 280px;
        overflow: auto;
        padding-right: 6px;
        scrollbar-width: thin;
        scrollbar-color: #4b5563 transparent;
      }

      .tree-node {
        margin-left: 14px;
        border-left: 1px dashed rgba(75, 85, 99, 0.7);
        padding-left: 8px;
        margin-bottom: 4px;
        padding-bottom: 2px;
        position: relative;
        animation: fadeIn 0.3s ease-out;
      }

      .tree-node::before {
        content: "";
        position: absolute;
        left: -1px;
        top: 12px;
        width: 8px;
        height: 1px;
        background: rgba(75, 85, 99, 0.8);
      }

      .tree-label {
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(148, 163, 184, 0.4);
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .tree-label span.id {
        font-size: 10px;
        color: #9ca3af;
      }

      .tree-label span.name {
        font-weight: 500;
      }

      .tree-label span.meta {
        font-size: 10px;
        color: #9ca3af;
      }

      .tree-node.root {
        margin-left: 0;
        border-left: none;
      }

      .tree-node.root::before {
        display: none;
      }

      .logs {
        margin-top: 8px;
        max-height: 440px;
        overflow: auto;
        padding-right: 6px;
        scrollbar-width: thin;
        scrollbar-color: #4b5563 transparent;
      }

      .log-item {
        font-size: 11px;
        padding: 6px 8px;
        border-radius: 8px;
        border: 1px solid rgba(31, 41, 55, 0.9);
        background: linear-gradient(
          to right,
          rgba(15, 23, 42, 0.95),
          rgba(15, 23, 42, 0.4)
        );
        margin-bottom: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 6px;
        opacity: 0;
        transform: translateY(6px);
        animation: logIn 0.32s ease-out forwards;
      }

      .log-item .left {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .log-item .label {
        font-size: 10px;
        color: #9ca3af;
      }

      .log-item .main {
        font-size: 11px;
        color: #e5e7eb;
      }

      .log-item .tag {
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.7);
        color: #9ca3af;
        white-space: nowrap;
      }

      .log-item.call .tag {
        border-color: rgba(56, 189, 248, 0.8);
        color: #7dd3fc;
      }

      .log-item.return .tag {
        border-color: rgba(168, 85, 247, 0.8);
        color: #e9d5ff;
      }

      .status-bar {
        margin-top: 6px;
        font-size: 11px;
        color: #9ca3af;
        display: flex;
        justify-content: space-between;
        gap: 8px;
        align-items: center;
      }

      .status-highlight {
        color: #e5e7eb;
        font-weight: 500;
      }

      @keyframes logIn {
        from {
          opacity: 0;
          transform: translateY(6px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(4px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media (max-width: 900px) {
        .layout {
          grid-template-columns: minmax(0, 1fr);
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <div class="header">
        <div class="title-group">
          <h1>
            Mô phỏng đệ quy <code>nestedUsers()</code>
            <span class="title-pill">tree from flat array</span>
          </h1>
          <p>
            Quan sát từng lần gọi đệ quy, cách tìm con theo
            <code>parent</code> và gán <code>children</code>.
          </p>
        </div>
        <div class="controls">
          <button id="btnRun" class="btn btn-primary">▶ Chạy mô phỏng</button>
          <button id="btnReset" class="btn btn-secondary">↺ Reset</button>
        </div>
      </div>

      <div class="layout">
        <!-- Cột trái: dữ liệu phẳng + cây kết quả -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">
                <span class="icon">D</span>
                Dữ liệu phẳng &amp; Cây kết quả
              </div>
              <div class="card-subtitle">
                Mảng <code>users</code> và cấu trúc lồng nhau sau khi chạy
                <code>nestedUsers()</code>
              </div>
            </div>
            <span class="badge">input / output</span>
          </div>

          <div class="card-inner">
            <div class="card-subtitle" style="margin-bottom: 4px">
              Mảng <code>users</code> ban đầu:
            </div>
            <div id="flatList" class="list-flat"></div>

            <div class="card-subtitle" style="margin-top: 10px">
              Cây kết quả (sau khi chạy xong):
            </div>
            <div id="treeView" class="tree-view"></div>
          </div>
        </div>

        <!-- Cột phải: mô phỏng đệ quy -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">
                <span class="icon">R</span>
                Quy trình đệ quy <code>nestedUsers()</code>
              </div>
              <div class="card-subtitle">
                Theo dõi từng lần gọi hàm: <code>parent</code> hiện tại, danh
                sách con (<code>result</code>), và <code>children</code>.
              </div>
            </div>
            <span class="badge">recursion trace</span>
          </div>

          <div class="status-bar">
            <div>
              Gọi hiện tại:
              <span id="currentCall" class="status-highlight">Chưa chạy</span>
            </div>
            <div>
              Trạng thái:
              <span id="status" class="status-highlight">Đang chờ...</span>
            </div>
          </div>

          <div class="logs" id="logs"></div>
        </div>
      </div>
    </div>

    <script>
      const users = [
        { id: 1, name: "Item 1", parent: 0 },
        { id: 2, name: "Item 2", parent: 0 },
        { id: 3, name: "Item 3", parent: 0 },
        { id: 4, name: "Item 2.1", parent: 2 },
        { id: 5, name: "Item 2.2", parent: 2 },
        { id: 6, name: "Item 2.3", parent: 2 },
        { id: 7, name: "Item 2.2.1", parent: 5 },
        { id: 8, name: "Item 2.2.2", parent: 5 },
      ];

      const flatListEl = document.getElementById("flatList");
      const treeViewEl = document.getElementById("treeView");
      const logsEl = document.getElementById("logs");
      const currentCallEl = document.getElementById("currentCall");
      const statusEl = document.getElementById("status");
      const btnRun = document.getElementById("btnRun");
      const btnReset = document.getElementById("btnReset");

      function renderFlatList() {
        flatListEl.innerHTML = "";
        users.forEach((user) => {
          const div = document.createElement("div");
          div.className = "node" + (user.parent === 0 ? " node-root" : "");
          div.dataset.id = user.id;

          div.innerHTML = `
          <div class="node-id">id: ${user.id}</div>
          <div class="node-name">${user.name}</div>
          <div class="node-parent">parent: ${user.parent}</div>
        `;

          flatListEl.appendChild(div);
        });
      }

      function renderTree(tree) {
        treeViewEl.innerHTML = "";
        function renderNode(node, isRoot = false) {
          const wrapper = document.createElement("div");
          wrapper.className = "tree-node" + (isRoot ? " root" : "");
          const label = document.createElement("div");
          label.className = "tree-label";
          label.innerHTML = `
          <span class="id">#${node.id}</span>
          <span class="name">${node.name}</span>
          <span class="meta">(parent: ${node.parent})</span>
        `;
          wrapper.appendChild(label);

          if (node.children && node.children.length) {
            node.children.forEach((child) => {
              wrapper.appendChild(renderNode(child, false));
            });
          }

          return wrapper;
        }

        tree.forEach((rootNode) => {
          treeViewEl.appendChild(renderNode(rootNode, true));
        });
      }

      function clearHighlights() {
        document.querySelectorAll(".node").forEach((el) => {
          el.classList.remove("node-current", "node-child");
        });
      }

      function highlightCurrentAndChildren(parentId, childrenIds) {
        clearHighlights();
        if (parentId !== null) {
          const current = document.querySelector(
            `.node[data-id="${parentId}"]`
          );
          if (current) current.classList.add("node-current");
        }
        if (childrenIds && childrenIds.length) {
          childrenIds.forEach((id) => {
            const child = document.querySelector(`.node[data-id="${id}"]`);
            if (child) child.classList.add("node-child");
          });
        }
      }

      function createLog({ type, parent, resultIds }) {
        const div = document.createElement("div");
        div.className = "log-item " + type;

        const listStr = resultIds.length ? resultIds.join(", ") : "[]";

        if (type === "call") {
          div.innerHTML = `
          <div class="left">
            <div class="label">Gọi nestedUsers(list, parent = ${parent})</div>
            <div class="main">Tìm các phần tử có <code>parent === ${parent}</code>.</div>
          </div>
          <div class="tag">CALL</div>
        `;
        } else {
          div.innerHTML = `
          <div class="left">
            <div class="label">Trả về từ parent = ${parent}</div>
            <div class="main">result (children): [${listStr}] → result.length = ${resultIds.length}</div>
          </div>
          <div class="tag">RETURN</div>
        `;
        }

        logsEl.appendChild(div);
        logsEl.scrollTop = logsEl.scrollHeight;
      }

      function buildSteps(list) {
        const steps = [];

        function nestedUsersTrace(list, parent = 0) {
          steps.push({ type: "call", parent });

          let arr = [];
          list.forEach((user) => {
            if (user.parent === parent) {
              arr.push(user);
              const result = nestedUsersTrace(list, user.id);
              steps.push({
                type: "return",
                parent: user.id,
                resultIds: result.map((u) => u.id),
              });
              if (result.length) {
                user.children = result;
              }
            }
          });
          return arr;
        }

        const cloned = list.map((u) => ({ ...u }));
        const tree = nestedUsersTrace(cloned, 0);
        return { steps, tree };
      }

      function playSteps(steps) {
        let i = 0;
        const total = steps.length;

        function runStep() {
          if (i >= total) {
            statusEl.textContent = "Hoàn thành! Xem cây kết quả bên trái.";
            btnRun.disabled = false;
            return;
          }

          const step = steps[i];

          if (step.type === "call") {
            currentCallEl.textContent = `nestedUsers(list, parent = ${step.parent})`;
            statusEl.textContent =
              "Đang tìm các phần tử có parent = " + step.parent;
            const childrenIds = users
              .filter((u) => u.parent === step.parent)
              .map((u) => u.id);
            highlightCurrentAndChildren(
              step.parent === 0 ? null : step.parent,
              childrenIds
            );
            createLog({ type: "call", parent: step.parent, resultIds: [] });
          } else {
            currentCallEl.textContent = `Kết thúc xử lý parent = ${step.parent}`;
            statusEl.textContent = `Trả về ${step.resultIds.length} phần tử cho parent = ${step.parent}`;
            highlightCurrentAndChildren(step.parent, step.resultIds);
            createLog({
              type: "return",
              parent: step.parent,
              resultIds: step.resultIds,
            });
          }

          i++;
          setTimeout(runStep, 1000);
        }

        runStep();
      }

      function resetUI() {
        logsEl.innerHTML = "";
        treeViewEl.innerHTML = "";
        currentCallEl.textContent = "Chưa chạy";
        statusEl.textContent = "Đang chờ...";
        clearHighlights();
      }

      renderFlatList();

      btnRun.addEventListener("click", () => {
        resetUI();
        btnRun.disabled = true;
        statusEl.textContent = "Đang chạy mô phỏng...";
        const { steps, tree } = buildSteps(users);
        renderTree(tree);
        playSteps(steps);
      });

      btnReset.addEventListener("click", () => {
        window.location.reload();
      });
    </script>
    <script src="./js/ex01.js"></script>
  </body>
</html>
